define([cenozoApp.module("application").getFileUrl("module.js")],function(){"use strict";var module=cenozoApp.module("application");if(angular.isDefined(cenozoApp.module("participant").actions.release)){module.addExtraOperation("list",{title:"Manage Applications",isIncluded:function($state,model){return"participant"==model.getSubjectFromState()},operation:function($state,model){$state.go("participant.release",$state.params)}})}if(angular.isDefined(module.actions.release)){module.addExtraOperation("view",{title:"Manage Participants",operation:function($state,model){$state.go("application.release",$state.params)},isIncluded:function($state,model){return model.viewModel.record.release_based}})}cenozo.providers.directive("cnApplicationRelease",["CnApplicationReleaseFactory","$timeout",function(CnApplicationReleaseFactory,$timeout){return{templateUrl:cenozoApp.baseUrl+"/app/application/release.tpl.html?build="+cenozoApp.build,restrict:"E",controller:function($scope){$scope.model=CnApplicationReleaseFactory.instance();$scope.confirm=function(){$scope.model.confirm();$timeout(function(){angular.element("#uidListString").trigger("keyup")},100)}}}}]);cenozo.providers.factory("CnApplicationReleaseFactory",["CnSession","CnHttpFactory","CnModalMessageFactory","$state","$q",function(CnSession,CnHttpFactory,CnModalMessageFactory,$state,$q){var object=function(){var self=this;this.application=null;this.applicationSiteList=[];this.reset=function(){self.confirmInProgress=false;self.confirmedCount=null;self.uidListString="";self.uidList=[];self.cohortSiteList=null;self.preferredSiteId=null};this.reset();CnHttpFactory.instance({path:"application/"+$state.params.identifier,data:{select:{column:["title","release_based"]}}}).get().then(function(response){self.application=response.data;self.application.identifier=$state.params.identifier;if(!self.application.release_based)$state.go("error.404");else{CnSession.setBreadcrumbTrail([{title:"Applications",go:function(){$state.go("application.list")}},{title:response.data.title,go:function(){$state.go("application.view",{identifier:$state.params.identifier})}},{title:"Release"}])}});CnHttpFactory.instance({path:"application/"+$state.params.identifier+"/site",data:{select:{column:["name"]}}}).get().then(function(response){self.applicationSiteList=response.data;response.data.unshift({id:null,name:"No Preferred Site"})});this.uidListStringChanged=function(){this.confirmedCount=null};this.confirm=function(){this.confirmInProgress=true;this.confirmedCount=null;this.uidList=this.uidListString.toUpperCase().replace(/[\s,;|\/]/g," ").replace(/[^a-zA-Z0-9 ]/g,"").split(" ").filter(function(uid){return null!=uid.match(/^[A-Z][0-9]{6}$/)}).filter(function(uid,index,array){return index<=array.indexOf(uid)}).sort();if(0==this.uidList.length){this.uidListString="";this.confirmInProgress=false}else{CnHttpFactory.instance({path:"participant",data:{mode:"unreleased_only",application_id:this.application.id,uid_list:this.uidList}}).post().then(function(response){self.confirmedCount=response.data.uid_list.length;self.uidListString=response.data.uid_list.join(" ");self.cohortSiteList=response.data.site_list;self.confirmInProgress=false})}};this.setPreferredSite=function(siteId){if(!this.confirmInProgress&&0<this.confirmedCount){CnHttpFactory.instance({path:"participant",data:{mode:"preferred_site",application_id:self.application.id,site_id:siteId,uid_list:this.uidList}}).post().then(function(response){CnModalMessageFactory.instance({title:"Participants Released",message:"You have successfully released "+self.confirmedCount+" participants to "+self.application.title}).show().then(function(){self.confirm()})})}};this.release=function(){if(!this.confirmInProgress&&0<this.confirmedCount){CnHttpFactory.instance({path:"participant",data:{mode:"release",application_id:self.application.id,uid_list:this.uidList}}).post().then(function(response){CnModalMessageFactory.instance({title:"Participants Released",message:"You have successfully released "+self.confirmedCount+" participants to "+self.application.title}).show().then(function(){self.reset()})})}}};return{instance:function(){return new object(false)}}}])});
